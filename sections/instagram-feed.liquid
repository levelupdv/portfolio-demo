<div class="instagram-feed-section">
  <div class="container">
    {% if section.settings.heading != blank %}
      <h2 class="instagram-heading">{{ section.settings.heading }}</h2>
    {% endif %}

    {% if section.settings.subheading != blank %}
      <p class="instagram-subheading">{{ section.settings.subheading }}</p>
    {% endif %}

    <div class="instagram-grid">
      {% for block in section.blocks %}
        <div class="instagram-item" {{ block.shopify_attributes }}>
          <a href="{{ block.settings.link }}" target="_blank" rel="noopener" class="instagram-link">
            {% comment %} Check if it's a video post {% endcomment %}
            {% if block.type == 'instagram_video' and block.settings.video_file != blank %}
              <video
                class="instagram-video"
                playsinline
                muted
                loop
                {% if block.settings.autoplay %}
                  autoplay
                {% endif %}
              >
                {% for source in block.settings.video_file.sources %}
                  <source src="{{ source.url }}" type="{{ source.mime_type }}">
                {% endfor %}
              </video>

              {% comment %} Video play icon overlay {% endcomment %}
              <div class="video-play-icon">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="48"
                  height="48"
                  viewBox="0 0 24 24"
                  fill="white"
                  opacity="0.9"
                >
                  <polygon points="10,8 16,12 10,16" fill="white"/>
                </svg>
              </div>

              {% comment %} Otherwise show image {% endcomment %}
            {% elsif block.type == 'instagram_post' and block.settings.image != blank %}
              <img
                src="{{ block.settings.image | image_url: width: 800, height:  800, crop: 'top' }}"
                alt="{{ block.settings.image.alt | default: 'Instagram post' }}"
                width="800"
                height="800"
                loading="lazy"
              >
            {% endif %}

            {% comment %} Instagram icon overlay (for both image and video) {% endcomment %}
            <div class="instagram-overlay">
              <span class="instagram-icon">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <rect x="2" y="2" width="20" height="20" rx="5" ry="5"></rect>
                  <path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"></path>
                  <line x1="17.5" y1="6.5" x2="17.51" y2="6.5"></line>
                </svg>
              </span>
            </div>
          </a>
        </div>
      {% endfor %}
    </div>

    {% if section.settings.button_text != blank %}
      <div class="instagram-button-wrapper">
        <a href="{{ section.settings.button_link }}" class="instagram-follow-btn" target="_blank" rel="noopener">
          {{ section.settings.button_text }}
        </a>
      </div>
    {% endif %}
  </div>
</div>

<style>
  .instagram-feed-section {
    padding:  30px 0px 37px 0px;
    background-color: {{ section.settings.background_color }};
  }

  .container {
    max-width: 100%;
  }

  .instagram-heading {
    text-align: center;
    font-size: 36px;
    margin-top: 0;
    margin-bottom: 0px;
    color: {{ section.settings.heading_color }};
  }

  .instagram-subheading {
    text-align: center;
    font-size: 16px;
    color: #666;
    margin-top:  0px;
    margin-bottom: 0px;
    padding-bottom: 30px;
  }

  .instagram-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: {{ section.settings.grid_gap }}px;
  }

  @media (min-width: 768px) {
    .instagram-grid {
      grid-template-columns: repeat({{ section.settings.columns_desktop }}, 1fr);
    }
  }

  @media (max-width: 767px) {
    .instagram-grid {
      grid-template-columns: repeat({{ section.settings.columns_mobile }}, 1fr);
    }
  }

  .instagram-item {
    position: relative;
    overflow: hidden;
    border-radius: {{ section.settings.border_radius }}px;
  }

  .instagram-link {
    display: block;
    width: 100%;
    height: 100%;
    position:  relative;
  }

  .instagram-item img,
  .instagram-item video {
    width: 100%;
    height:  100%;
    object-fit: cover;
    transition: transform 0.5s ease;
  }

  /* Video specific styles */
  .instagram-video {
    display: block;
  }

  .video-play-icon {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    pointer-events: none;
    z-index: 2;
    opacity: 0;
    transition: opacity 0.3s ease;
  }

  .instagram-item:has(video):hover .video-play-icon {
    opacity: 0.9;
  }

  .instagram-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height:  100%;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    opacity:  0;
    transition: opacity 0.3s ease;
  }

  .instagram-item:has(img):hover .instagram-overlay {
    opacity: 1;
  }

  .instagram-item:hover img,
  .instagram-item:hover video {
    transform:  scale(1.1);
  }

  .instagram-icon {
    color: white;
  }

  .instagram-button-wrapper {
    text-align:  center;
  }

  .instagram-follow-btn {
    display: inline-block;
    padding: 15px 40px;
    background:  linear-gradient(45deg, #f09433 0%, #e6683c 25%, #dc2743 50%, #cc2366 75%, #bc1888 100%);
    color: white;
    text-decoration:  none;
    border-radius:  30px;
    font-weight: 600;
    transition: transform 0.3s ease;
  }

  .instagram-follow-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
  }
</style>

{% comment %} JavaScript for video hover play/pause {% endcomment %}
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const instagramItems = document.querySelectorAll('.instagram-item');

    instagramItems.forEach((item) => {
      const video = item.querySelector('video');

      if (video && !video.hasAttribute('autoplay')) {
        // Play video on hover
        item.addEventListener('mouseenter', function () {
          video.play();
        });

        // Pause video when not hovering
        item.addEventListener('mouseleave', function () {
          video.pause();
          video.currentTime = 0;
        });
      }
    });
  });
</script>

{% schema %}
{
  "name": "Instagram Feed",
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "Follow Us on Instagram"
    },
    {
      "type": "text",
      "id": "subheading",
      "label": "Subheading",
      "default": "@yourinstagramhandle"
    },
    {
      "type": "color",
      "id": "heading_color",
      "label": "Heading Color",
      "default": "#000000"
    },
    {
      "type": "color",
      "id": "background_color",
      "label": "Background Color",
      "default": "#ffffff"
    },
    {
      "type": "range",
      "id": "columns_desktop",
      "min": 2,
      "max": 6,
      "step": 1,
      "label": "Columns (Desktop)",
      "default": 4
    },
    {
      "type": "range",
      "id": "columns_mobile",
      "min": 1,
      "max": 3,
      "step": 1,
      "label": "Columns (Mobile)",
      "default": 2
    },
    {
      "type": "range",
      "id": "grid_gap",
      "min": 0,
      "max": 50,
      "step": 1,
      "label": "Gap Between Images",
      "default": 10,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "border_radius",
      "min": 0,
      "max": 30,
      "step": 5,
      "label": "Image Border Radius",
      "default": 0,
      "unit": "px"
    },
    {
      "type": "text",
      "id": "button_text",
      "label": "Button Text",
      "default": "Follow Us on Instagram"
    },
    {
      "type": "url",
      "id": "button_link",
      "label": "Button Link",
      "info": "Link to your Instagram profile"
    }
  ],
  "blocks": [
    {
      "type": "instagram_post",
      "name": "Instagram Post",
      "settings": [
        {
          "type": "image_picker",
          "id": "image",
          "label": "Image"
        },
        {
          "type": "url",
          "id": "link",
          "label": "Instagram Post Link",
          "info": "Link to the Instagram post"
        }
      ]
    },
    {
      "type": "instagram_video",
      "name": "Instagram Video",
      "settings": [
        {
          "type": "video",
          "id": "video_file",
          "label": "Video"
        },
        {
          "type": "checkbox",
          "id": "autoplay",
          "label": "Autoplay Video",
          "default": false,
          "info": "Video will play automatically (muted). If unchecked, video plays on hover."
        },
        {
          "type": "url",
          "id": "link",
          "label": "Instagram Post Link",
          "info": "Link to the Instagram video post"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Instagram Feed",
      "blocks": [
        {
          "type": "instagram_post"
        },
        {
          "type": "instagram_post"
        },
        {
          "type": "instagram_post"
        },
        {
          "type": "instagram_post"
        },
        {
          "type": "instagram_post"
        },
        {
          "type": "instagram_post"
        }
      ]
    }
  ]
}
{% endschema %}
